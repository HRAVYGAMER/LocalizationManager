#!/usr/bin/make -f
# debian/rules for lrm

export DH_VERBOSE=1
export DOTNET_CLI_TELEMETRY_OPTOUT=1
export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1

# Determine architecture
DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)

ifeq ($(DEB_HOST_ARCH),amd64)
    DOTNET_RID := linux-x64
else ifeq ($(DEB_HOST_ARCH),arm64)
    DOTNET_RID := linux-arm64
endif

%:
	dh $@

override_dh_auto_build:
	# Build framework-dependent version (for lrm package)
	dotnet publish -c Release -r $(DOTNET_RID) \
		--self-contained false \
		-p:PublishSingleFile=true \
		-o $(CURDIR)/debian/build/lrm

	# Build self-contained version (for lrm-standalone package)
	dotnet publish -c Release -r $(DOTNET_RID) \
		--self-contained true \
		-p:PublishSingleFile=true \
		-p:PublishTrimmed=false \
		-o $(CURDIR)/debian/build/lrm-standalone

override_dh_auto_install:
	# Install framework-dependent binary
	install -D -m 0755 $(CURDIR)/debian/build/lrm/lrm \
		$(CURDIR)/debian/lrm/usr/bin/lrm

	# Install self-contained binary
	install -D -m 0755 $(CURDIR)/debian/build/lrm-standalone/lrm \
		$(CURDIR)/debian/lrm-standalone/usr/bin/lrm

	# Install man page (both packages)
	install -D -m 0644 $(CURDIR)/docs/lrm.1 \
		$(CURDIR)/debian/lrm/usr/share/man/man1/lrm.1
	install -D -m 0644 $(CURDIR)/docs/lrm.1 \
		$(CURDIR)/debian/lrm-standalone/usr/share/man/man1/lrm.1

	# Install bash completion (both packages)
	install -D -m 0644 $(CURDIR)/lrm-completion.bash \
		$(CURDIR)/debian/lrm/usr/share/bash-completion/completions/lrm
	install -D -m 0644 $(CURDIR)/lrm-completion.bash \
		$(CURDIR)/debian/lrm-standalone/usr/share/bash-completion/completions/lrm

	# Install zsh completion (both packages)
	install -D -m 0644 $(CURDIR)/_lrm \
		$(CURDIR)/debian/lrm/usr/share/zsh/site-functions/_lrm
	install -D -m 0644 $(CURDIR)/_lrm \
		$(CURDIR)/debian/lrm-standalone/usr/share/zsh/site-functions/_lrm

override_dh_auto_clean:
	rm -rf $(CURDIR)/debian/build
	dotnet clean || true

override_dh_auto_test:
	# Skip tests during package build
	# Tests are run in CI before release

override_dh_strip:
	# Don't strip .NET binaries
	dh_strip --exclude=lrm
